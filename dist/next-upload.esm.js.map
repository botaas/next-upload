{"version":3,"file":"next-upload.esm.js","sources":["../src/utils/client.ts","../src/utils/keys.ts","../src/app/api/upload/s3/route.ts","../src/components/FileInput.tsx","../src/hooks/use-upload-files.tsx","../src/hooks/use-uploader.ts","../src/hooks/use-s3-upload.tsx","../src/hooks/use-presigned-upload.ts","../src/utils/image-data.ts","../src/utils/private-files.ts"],"sourcesContent":["import { S3Client } from '@aws-sdk/client-s3';\nimport { S3Config } from './config';\n\nexport function getClient(config: S3Config) {\n  const client = new S3Client({\n    credentials: {\n      accessKeyId: config.accessKeyId,\n      secretAccessKey: config.secretAccessKey,\n    },\n    region: config.region,\n    ...(config.forcePathStyle ? { forcePathStyle: config.forcePathStyle } : {}),\n    ...(config.endpoint ? { endpoint: config.endpoint } : {}),\n  });\n\n  return client;\n}","import { v4 as uuidv4 } from 'uuid';\n\nexport const uuid = () => uuidv4();\n\nconst SAFE_CHARACTERS = /[^0-9a-zA-Z!_\\\\.\\\\*'\\\\(\\\\)\\\\\\-/]/g;\nexport const sanitizeKey = (value: string) =>\n  value.replace(SAFE_CHARACTERS, ' ').replace(/\\s+/g, '-');","import { NextRequest, NextResponse } from \"next/server\";\nimport { PutObjectCommand } from '@aws-sdk/client-s3';\nimport { S3Config } from '../../../../utils/config';\nimport { getClient } from '../../../../utils/client';\nimport { sanitizeKey, uuid } from '../../../../utils/keys';\nimport { getSignedUrl } from '@aws-sdk/s3-request-presigner';\nimport {\n  STSClient,\n  GetFederationTokenCommand,\n  STSClientConfig,\n} from '@aws-sdk/client-sts';\n\n\ntype Options = S3Config & {\n  key?: (request: Request, filename: string) => string | Promise<string>;\n};\n\ntype OptionsFetcher = (request: NextRequest) => Promise<Options>;\n\nconst makeRouteHandler = (optionsFetcher?: OptionsFetcher) => {\n  const route = async function (request: NextRequest) {    \n    const { strategy, filename, filetype } = await request.json();\n    if (!optionsFetcher) {\n      return new Response(\"S3 Upload: Missing config\", { status: 400 })\n    }\n\n    const options = await optionsFetcher(request);\n    if (!options) {\n      return new Response(\"S3 Upload: No config fetched\", { status: 400 })\n    }\n\n    const key = options.key ? await Promise.resolve(options.key(request, filename)) : `uploads/${uuid()}/${sanitizeKey(filename)}`;\n    let { bucket, region, endpoint } = options;\n\n    if (strategy === 'presigned') {\n      const client = getClient(options);\n  \n      const params = {\n        Bucket: bucket,\n        Key: key,\n        ContentType: filetype,\n        CacheControl: 'max-age=630720000',\n      }\n\n      const url = await getSignedUrl(client, new PutObjectCommand(params), {\n        expiresIn: 60 * 60,\n      });\n\n      return NextResponse.json({\n        key,\n        bucket,\n        region,\n        endpoint,\n        url,\n      });\n    } else {\n      let stsConfig: STSClientConfig = {\n        credentials: {\n          accessKeyId: options.accessKeyId,\n          secretAccessKey: options.secretAccessKey,\n        },\n        region,\n      };\n\n      const policy = {\n        Statement: [\n          {\n            Sid: 'Stmt1S3UploadAssets',\n            Effect: 'Allow',\n            Action: ['s3:PutObject'],\n            Resource: [`arn:aws:s3:::${bucket}/${key}`],\n          },\n        ],\n      };\n\n      const sts = new STSClient(stsConfig);\n\n      const command = new GetFederationTokenCommand({\n        Name: 'S3UploadWebToken',\n        Policy: JSON.stringify(policy),\n        DurationSeconds: 60 * 60, // 1 hour\n      });\n\n      const token = await sts.send(command);\n\n      return NextResponse.json({\n        token,\n        key,\n        bucket,\n        region,\n      });\n    }\n  }\n\n  let configure = (optionsFetcher: OptionsFetcher) => makeRouteHandler(optionsFetcher);\n  return Object.assign(route, { configure })\n}\n\nconst APIRoute = makeRouteHandler();\nexport { APIRoute }\n","import React, { ChangeEvent, InputHTMLAttributes } from 'react';\nimport { forwardRef } from 'react';\n\ntype FileInputProps = {\n  onChange: (\n    file: File | undefined,\n    event: ChangeEvent<HTMLInputElement>\n  ) => void;\n} & InputHTMLAttributes<HTMLInputElement>;\n\nexport const FileInput = forwardRef<HTMLInputElement, FileInputProps>(\n  ({ onChange = () => {}, ...restOfProps }, forwardedRef) => {\n    let handleChange = (event: ChangeEvent<HTMLInputElement>): void => {\n      let file = event.target?.files?.[0];\n      onChange(file, event);\n    };\n\n    return (\n      <input\n        onChange={handleChange}\n        {...restOfProps}\n        ref={forwardedRef}\n        type=\"file\"\n      />\n    );\n  }\n);","import React from 'react';\nimport { FileInput } from '../components/FileInput';\nimport { useRef, useState } from 'react';\n\ntype TrackedFile = {\n  file: File;\n  progress: number;\n  uploaded: number;\n  size: number;\n};\n\nexport const useUploadFiles = () => {\n  let ref = useRef<HTMLInputElement>();\n  let [files, setFiles] = useState<TrackedFile[]>([]);\n\n  let openFileDialog = () => {\n    if (ref.current) {\n      ref.current.value = '';\n      ref.current?.click();\n    }\n  };\n\n  let resetFiles = () => {\n    setFiles([]);\n  };\n\n  let updateFileProgress = (file: File, uploaded: number) => {\n    setFiles(files =>\n      files.map(trackedFile =>\n        trackedFile.file === file\n          ? {\n              file,\n              uploaded,\n              size: file.size,\n              progress: file.size ? (uploaded / file.size) * 100 : 0,\n            }\n          : trackedFile\n      )\n    );\n  };\n\n  let addFile = (file: File) => {\n    setFiles(files => [\n      ...files,\n      { file, progress: 0, uploaded: 0, size: file.size },\n    ]);\n  };\n\n  return {\n    FileInput: (props: any) => (\n      <FileInput {...props} ref={ref} style={{ display: 'none' }} />\n    ),\n    openFileDialog,\n    files,\n    addFile,\n    updateFileProgress,\n    resetFiles,\n  };\n};","import { useUploadFiles } from './use-upload-files';\n\ntype UploadResult = {\n  url: string;\n  bucket: string;\n  key: string;\n};\n\ntype RequestOptions = {\n  url?: string;\n  body?: Record<string, any>;\n  headers?: HeadersInit;\n};\n\ntype UploadToS3Options = {\n  endpoint?: {\n    request: RequestOptions;\n  };\n};\n\n// Outdated options we no longer want support.\ntype OldOptions = {\n  endpoint: string;\n};\n\ntype Strategy = 'presigned' | 'aws-sdk';\n\nexport type Uploader<P = any> = (\n  file: File,\n  params: P,\n  eventHandlers: {\n    onProgress: (uploaded: number) => void;\n  }\n) => Promise<UploadResult>;\n\nexport const useUploader = (\n  strategy: Strategy,\n  uploader: Uploader,\n  oldOptions?: OldOptions\n) => {\n  let {\n    addFile,\n    updateFileProgress,\n    FileInput,\n    openFileDialog,\n    files,\n    resetFiles,\n  } = useUploadFiles();\n\n  let uploadToS3 = async (file: File, options: UploadToS3Options = {}) => {\n    // combine old options and new options. remove after 1.0\n    if (oldOptions?.endpoint) {\n      if (process.env.NODE_ENV === 'development') {\n        console.warn(\n          '[Next S3 Upload] The `endpoint` option has been replaced by `endpoint.request.url`. For more information see: https://next-s3-upload.codingvalue.com/changes/endpoint'\n        );\n      }\n\n      if (options.endpoint) {\n        options.endpoint.request.url = oldOptions.endpoint;\n      } else {\n        options.endpoint = {\n          request: {\n            url: oldOptions.endpoint,\n          },\n        };\n      }\n    }\n\n    const params = await getUploadParams(\n      strategy,\n      file,\n      options.endpoint?.request\n    );\n\n    if (params.error) {\n      console.error(params.error);\n      throw params.error;\n    }\n\n    addFile(file);\n\n    const result = await uploader(file, params, {\n      onProgress: uploaded => updateFileProgress(file, uploaded),\n    });\n\n    return result;\n  };\n\n  return {\n    FileInput,\n    openFileDialog,\n    uploadToS3,\n    files,\n    resetFiles,\n  };\n};\n\nlet getUploadParams = async (\n  strategy: Strategy,\n  file: File,\n  requestOptions?: RequestOptions\n) => {\n  let additionalBody = requestOptions?.body ?? {};\n  let additionalHeaders = requestOptions?.headers ?? {};\n  let apiRouteUrl = requestOptions?.url ?? '/api/upload/s3';\n\n  let body = {\n    filename: file.name,\n    filetype: file.type,\n    strategy,\n    ...additionalBody,\n  };\n\n  let headers = {\n    ...additionalHeaders,\n    'Content-Type': 'application/json',\n  };\n\n  let res = await fetch(apiRouteUrl, {\n    method: 'POST',\n    headers,\n    body: JSON.stringify(body),\n  });\n\n  return await res.json();\n};","import {\n  CompleteMultipartUploadCommandOutput,\n  S3Client,\n} from '@aws-sdk/client-s3';\nimport { Upload } from '@aws-sdk/lib-storage';\nimport { Uploader, useUploader } from './use-uploader';\n\ntype Params = {\n  key: string;\n  bucket: string;\n  token: Record<string, any>;\n  region: string;\n};\n\nlet upload: Uploader<Params> = async (file, params, { onProgress }) => {\n  let { key, bucket, token, region } = params;\n\n  let client = new S3Client({\n    credentials: {\n      accessKeyId: token.Credentials.AccessKeyId,\n      secretAccessKey: token.Credentials.SecretAccessKey,\n      sessionToken: token.Credentials.SessionToken,\n    },\n    region: region,\n  });\n\n  let uploadParams = {\n    Bucket: bucket,\n    Key: key,\n    Body: file,\n    CacheControl: 'max-age=630720000, public',\n    ContentType: file.type,\n  };\n\n  // at some point make this configurable\n  // let uploadOptions = {\n  //   partSize: 100 * 1024 * 1024,\n  //   queueSize: 1,\n  // };\n\n  let s3Upload = new Upload({\n    client,\n    params: uploadParams,\n  });\n\n  s3Upload.on('httpUploadProgress', progress => {\n    let uploaded = progress.loaded ?? 0;\n    onProgress(uploaded);\n  });\n\n  let uploadResult = (await s3Upload.done()) as CompleteMultipartUploadCommandOutput;\n\n  let url =\n    uploadResult.Bucket && uploadResult.Key\n      ? `https://${uploadResult.Bucket}.s3.${region}.amazonaws.com/${uploadResult.Key}`\n      : '';\n\n  return {\n    url,\n    bucket: uploadResult.Bucket ?? '',\n    key: uploadResult.Key ?? '',\n  };\n};\n\nexport const useS3Upload = (options?: { endpoint: string }) => {\n  let hook = useUploader('aws-sdk', upload, options);\n  return hook;\n};","import { Uploader, useUploader } from './use-uploader';\n\nlet upload: Uploader = async (file, params, { onProgress }) => {\n  let { url, key, bucket, region, endpoint } = params;\n  let buffer = await file.arrayBuffer();\n\n  await new Promise<void>((resolve, reject) => {\n    let xhr = new XMLHttpRequest();\n\n    xhr.upload.onprogress = (event: ProgressEvent) => {\n      onProgress(event.loaded);\n    };\n\n    xhr.open('PUT', url, true);\n    xhr.setRequestHeader('Content-Type', file.type);\n    xhr.setRequestHeader('Cache-Control', 'max-age=630720000');\n\n    xhr.onreadystatechange = function() {\n      if (xhr.readyState === 4) {\n        if (xhr.status >= 200 && xhr.status < 300) {\n          resolve();\n        } else {\n          reject();\n        }\n      }\n    };\n\n    xhr.send(buffer);\n  });\n\n  let resultUrl = endpoint\n    ? `${endpoint}/${bucket}/${key}`\n    : `https://${bucket}.s3.${region}.amazonaws.com/${key}`;\n\n  return {\n    url: resultUrl,\n    bucket,\n    key,\n  };\n};\n\nexport const usePresignedUpload = () => {\n  let hook = useUploader('presigned', upload);\n  return hook;\n};","interface ImageData {\n  height: number | undefined;\n  width: number | undefined;\n}\n\nexport const getImageData = (file: File | Blob): Promise<ImageData> => {\n  return new Promise(resolve => {\n    if (file.type.split('/')?.[0] === 'image') {\n      let img = new Image();\n      let objectUrl = URL.createObjectURL(file);\n      img.onload = (event: Event) => {\n        let image = event.target as HTMLImageElement;\n        resolve({ height: image.height, width: image.width });\n        URL.revokeObjectURL(objectUrl);\n      };\n      img.src = objectUrl;\n    } else {\n      resolve({ height: undefined, width: undefined });\n    }\n  });\n};","import { getSignedUrl } from '@aws-sdk/s3-request-presigner';\nimport { GetObjectCommand } from '@aws-sdk/client-s3';\nimport { S3Config } from './config';\nimport { getClient } from './client';\n\nexport const generateTemporaryUrl = async (\n  key: string,\n  config: S3Config\n) => {\n  let client = getClient(config);\n\n  let command = new GetObjectCommand({\n    Bucket: config.bucket,\n    Key: key,\n  });\n\n  let url = await getSignedUrl(client, command, { expiresIn: 3600 });\n\n  return url;\n};"],"names":["getClient","config","client","S3Client","_extends","credentials","accessKeyId","secretAccessKey","region","forcePathStyle","endpoint","uuid","uuidv4","SAFE_CHARACTERS","sanitizeKey","value","replace","makeRouteHandler","optionsFetcher","route","_ref","_asyncToGenerator","_regeneratorRuntime","mark","_callee","request","_yield$request$json","strategy","filename","filetype","options","key","bucket","params","url","stsConfig","policy","sts","command","token","wrap","_callee$","_context","prev","next","json","sent","abrupt","Response","status","Promise","resolve","t0","Bucket","Key","ContentType","CacheControl","getSignedUrl","PutObjectCommand","expiresIn","NextResponse","Statement","Sid","Effect","Action","Resource","STSClient","GetFederationTokenCommand","Name","Policy","JSON","stringify","DurationSeconds","send","stop","_x","apply","arguments","configure","Object","assign","APIRoute","FileInput","forwardRef","forwardedRef","onChange","_ref$onChange","restOfProps","_objectWithoutPropertiesLoose","_excluded","handleChange","event","file","_event$target","target","_event$target$files","files","React","ref","type","useUploadFiles","useRef","_useState","useState","setFiles","openFileDialog","current","_ref$current","click","resetFiles","updateFileProgress","uploaded","map","trackedFile","size","progress","addFile","concat","props","style","display","useUploader","uploader","oldOptions","_useUploadFiles","uploadToS3","process","env","NODE_ENV","console","warn","getUploadParams","_options$endpoint","error","onProgress","result","_x2","_ref2","_callee2","requestOptions","_requestOptions$body","_requestOptions$heade","_requestOptions$url","additionalBody","additionalHeaders","apiRouteUrl","body","headers","res","_callee2$","_context2","name","fetch","method","_x3","_x4","_x5","upload","_uploadResult$Bucket","_uploadResult$Key","uploadParams","s3Upload","uploadResult","Credentials","AccessKeyId","SecretAccessKey","sessionToken","SessionToken","Body","Upload","on","_progress$loaded","loaded","done","useS3Upload","hook","buffer","resultUrl","arrayBuffer","reject","xhr","XMLHttpRequest","onprogress","open","setRequestHeader","onreadystatechange","readyState","usePresignedUpload","getImageData","_file$type$split","split","img","Image","objectUrl","URL","createObjectURL","onload","image","height","width","revokeObjectURL","src","undefined","generateTemporaryUrl","GetObjectCommand"],"mappings":"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"}